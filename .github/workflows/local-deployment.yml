name: Local MLOps Deployment

on:
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'

jobs:
  setup-model:
    name: Setup Production Model
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-deploy.txt
      
      - name: Create Required Directories
        run: |
          mkdir -p deployment/models
      
      - name: Create .env File
        run: |
          echo "DATABRICKS_HOST=${{ secrets.DATABRICKS_HOST }}" >> .env
          echo "DATABRICKS_TOKEN=${{ secrets.DATABRICKS_TOKEN }}" >> .env
          echo "MODEL_NAME=workspace.ml_credit_risk.credit_risk_model_random_forest" >> .env
          echo "MODEL_ALIAS=Production" >> .env
          echo "USE_SERVING_ENDPOINT=true" >> .env
          echo "SERVING_ENDPOINT_NAME=credit-risk-model-random_forest-prod" >> .env

      - name: Setup Model (Endpoint or Download)
        run: python deployment/pull_production_model.py

      - name: Verify Model Setup
        run: |
          if [ ! -f "deployment/models/endpoint_config.json" ]; then
            echo "❌ endpoint_config.json not found"
            exit 1
          fi

      - name: Upload Model Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-model
          path: deployment/models/
          retention-days: 7


  test-api:
    name: Test API Service
    runs-on: ubuntu-latest
    needs: setup-model
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download Model Artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-model
          path: deployment/

      - name: Move endpoint files to correct location
        run: |
          mkdir -p deployment/models
          mv deployment/production-model/* deployment/models/ || echo "⚠ Nothing to move"
          ls -la deployment/models

      - name: Create .env File
        run: |
          echo "DATABRICKS_HOST=${{ secrets.DATABRICKS_HOST }}" >> .env
          echo "DATABRICKS_TOKEN=${{ secrets.DATABRICKS_TOKEN }}" >> .env
          echo "MODEL_NAME=workspace.ml_credit_risk.credit_risk_model_random_forest" >> .env
          echo "MODEL_ALIAS=Production" >> .env
          echo "USE_SERVING_ENDPOINT=true" >> .env
          echo "API_HOST=0.0.0.0" >> .env
          echo "API_PORT=8000" >> .env
          cp .env deployment/.env

      - name: Start API Service (Script Version)
        run: bash deployment/start_api.sh

      - name: Debug API Status
        run: bash deployment/debug_api.sh

      - name: Test API Functionality
        run: |
          curl -f http://localhost:8000/health
          python deployment/test_api.py

      - name: Stop API Service
        if: always()
        run: |
          cd deployment
          kill $(cat api.pid) || true

      - name: Upload Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-logs
          path: deployment/api.log


  build-package:
    name: Build Deployment Package
    runs-on: ubuntu-latest
    needs: test-api
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Model Artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-model
          path: deployment/models/

      - name: Create Deployment Package
        run: |
          tar -czf mlops-deployment-${{ github.run_number }}.tar.gz deployment/ requirements*.txt

      - name: Upload Deployment Package
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: mlops-deployment-${{ github.run_number }}.tar.gz


  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [setup-model, test-api, build-package]
    if: always()

    steps:
      - name: Send Slack Notification
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {"text":":rocket: Deployment Completed!"}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
