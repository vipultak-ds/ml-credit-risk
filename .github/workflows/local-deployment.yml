name: Local MLOps Deployment

on:
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'

jobs:
  setup-model:
    name: Setup Production Model
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-deploy.txt
      
      - name: Create Required Directories
        run: |
          echo "üìÅ Creating deployment directories..."
          mkdir -p deployment/models
          ls -la deployment/
          echo "‚úÖ Directories created"
      
      - name: Create .env File
        run: |
          echo "DATABRICKS_HOST=${{ secrets.DATABRICKS_HOST }}" >> .env
          echo "DATABRICKS_TOKEN=${{ secrets.DATABRICKS_TOKEN }}" >> .env
          echo "MODEL_NAME=workspace.ml_credit_risk.credit_risk_model_random_forest" >> .env
          echo "MODEL_ALIAS=Production" >> .env
          echo "USE_SERVING_ENDPOINT=true" >> .env
          echo "SERVING_ENDPOINT_NAME=credit-risk-model-random_forest-prod" >> .env
          echo "üîé Using SERVING_ENDPOINT_NAME=$(grep SERVING_ENDPOINT_NAME .env | cut -d'=' -f2)"
          cat .env

      - name: Setup Model (Endpoint or Download)
        run: |
          python deployment/pull_production_model.py

      - name: Verify Model Setup
        run: |
          echo "üìÇ checking deployment/models ..."
          ls -la deployment/models || echo "‚ö†Ô∏è models folder missing"

          if [ -f "deployment/models/endpoint_config.json" ]; then
            echo "‚úÖ Serving endpoint configured"
            cat deployment/models/endpoint_config.json
          else
            echo "‚ùå endpoint_config.json not found"
            echo "üìã Current directory structure:"
            find deployment -type f || echo "No files found"
            exit 1
          fi

      - name: Upload Model Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-model
          path: deployment/models/
          retention-days: 7

  test-api:
    name: Test API Service
    runs-on: ubuntu-latest
    needs: setup-model
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create Required Directories
        run: |
          echo "üìÅ Creating deployment directories..."
          mkdir -p deployment/models
          ls -la deployment/
      
      - name: Download Model Artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-model
          path: deployment/models/
      
      - name: Create .env File
        run: |
          echo "DATABRICKS_HOST=${{ secrets.DATABRICKS_HOST }}" >> .env
          echo "DATABRICKS_TOKEN=${{ secrets.DATABRICKS_TOKEN }}" >> .env
          echo "MODEL_NAME=workspace.ml_credit_risk.credit_risk_model_random_forest" >> .env
          echo "MODEL_ALIAS=Production" >> .env
          echo "USE_SERVING_ENDPOINT=true" >> .env
          echo "SERVING_ENDPOINT_NAME=credit-risk-model-random_forest-prod" >> .env
          echo "API_HOST=0.0.0.0" >> .env
          echo "API_PORT=8000" >> .env
          echo "üîé Using SERVING_ENDPOINT_NAME=$(grep SERVING_ENDPOINT_NAME .env | cut -d'=' -f2)"
          
          # Copy .env to deployment directory for app.py
          cp .env deployment/.env
          
          cat .env

      - name: Check Model Configuration
        run: |
          echo "üìã Checking model configuration..."
          
          if [ -f "deployment/models/endpoint_config.json" ]; then
            echo "‚úÖ Using Databricks Serving Endpoint"
            cat deployment/models/endpoint_config.json | python -m json.tool
          elif [ -d "deployment/models/production_model" ]; then
            echo "‚úÖ Using Local Model"
            ls -la deployment/models/production_model/
          else
            echo "‚ùå No model configuration found"
            echo "üìã Files in deployment/models:"
            ls -la deployment/models/ || echo "Directory is empty"
            exit 1
          fi
      
      - name: Start API Service
        run: |
          cd deployment
          nohup python app.py > api.log 2>&1 &
          echo $! > api.pid
          sleep 10
      
      - name: Check API Health
        run: |
          cd deployment
          MAX_RETRIES=5
          for i in $(seq 1 $MAX_RETRIES); do
            if curl -f http://localhost:8000/health; then
              echo "‚úÖ API is healthy"
              exit 0
            fi
            echo "‚è≥ Waiting for API... ($i/$MAX_RETRIES)"
            sleep 5
          done
          echo "‚ùå API health check failed"
          cat api.log
          exit 1
      
      - name: Test API Functionality
        run: |
          echo "Testing /model/info..."
          curl -f http://localhost:8000/model/info | python -m json.tool

          echo "Testing full API script..."
          python deployment/test_api.py
      
      - name: Stop API Service
        if: always()
        run: |
          cd deployment
          kill $(cat api.pid) || true
      
      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-logs
          path: deployment/api.log

  build-package:
    name: Build Deployment Package
    runs-on: ubuntu-latest
    needs: test-api
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create Required Directories
        run: |
          mkdir -p deployment/models
      
      - name: Download Model Artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-model
          path: deployment/models/
      
      - name: Package Summary
        run: |
          echo "üì¶ Deployment Package Contents:"
          tree deployment/ || ls -laR deployment/
      
      - name: Create Deployment Package
        run: |
          tar -czf mlops-deployment-${{ github.run_number }}.tar.gz deployment/ requirements*.txt README.md

      - name: Upload Deployment Package
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: |
            mlops-deployment-${{ github.run_number }}.tar.gz

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [setup-model, test-api, build-package]
    if: always()
    
    steps:
      - name: Send Slack Notification
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": ":rocket: Deployment Finished (Status: ${{ needs.build-package.result }})",
              "attachments": [
                {
                  "color": "${{ needs.build-package.result == 'success' && 'good' || 'danger' }}",
                  "fields": [
                    { "title": "Run Number", "value": "${{ github.run_number }}", "short": true },
                    { "title": "Serving Endpoint", "value": "credit-risk-model-random_forest-prod", "short": true }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}