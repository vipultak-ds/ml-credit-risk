name: Databricks MLOps CI/CD

on:
  push:
    branches:
      - main
    paths:
      - "dev_env/**"
      - "scripts/**"
      - "pipeline_config.yml"
      - "experiments_config.yml"
      - "requirements.txt"
      - ".github/workflows/ci-cd-pipeline.yml"

env:
  DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
  DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

  # ‚úÖ Git variables (single source of truth)
  MODELS_TO_TRAIN: ${{ vars.MODELS_TO_TRAIN || 'all' }}
  MODEL_SERVING_CONFIG: ${{ vars.MODEL_SERVING_CONFIG || '{}' }}

jobs:
  deploy:
    name: Deploy Databricks MLOps Pipeline
    runs-on: ubuntu-latest

    steps:
      # ==========================================================
      # Step 1: Checkout Repository
      # ==========================================================
      - name: Checkout Repository
        uses: actions/checkout@v3

      # ==========================================================
      # Step 2: Setup Python
      # ==========================================================
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: "pip"

      # ==========================================================
      # Step 3: Install Dependencies
      # ==========================================================
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install databricks-sdk pyyaml

      # ==========================================================
      # Step 4: Validate MODELS_TO_TRAIN (NEW LOGIC)
      # ==========================================================
      - name: Validate Models Configuration
        run: |
          python3 << 'EOF'
          import yaml, os, sys

          models_input = os.getenv("MODELS_TO_TRAIN", "").strip()
          print(f"üîç MODELS_TO_TRAIN = '{models_input}'")

          try:
              with open("dev_env/experiments_config.yml") as f:
                  cfg = yaml.safe_load(f)
              available_models = list(cfg.get("models", {}).keys())
          except Exception as e:
              print(f"‚ùå Failed to load experiments_config.yml: {e}")
              sys.exit(1)

          print(f"üìã Available models: {available_models}")

          if not models_input or models_input.lower() in ["none", "null"]:
              print("‚ùå MODELS_TO_TRAIN is not set")
              sys.exit(1)

          if models_input.lower() != "all":
              selected = [m.strip() for m in models_input.split(",") if m.strip()]
              invalid = [m for m in selected if m not in available_models]
              if invalid:
                  print(f"‚ùå Invalid models: {invalid}")
                  sys.exit(1)

          print("‚úÖ Model validation passed")
          EOF

      # ==========================================================
      # Step 5: Sync Repo to Databricks
      # ==========================================================
      - name: Sync Git Repository to Databricks Repos
        run: python scripts/add_repo.py

      # ==========================================================
      # Step 6: Create / Update Databricks Jobs
      # (training + serving handled INSIDE Databricks)
      # ==========================================================
      - name: Create or Update Databricks Jobs
        env:
          MODELS_TO_TRAIN: ${{ env.MODELS_TO_TRAIN }}
          MODEL_SERVING_CONFIG: ${{ env.MODEL_SERVING_CONFIG }}
        run: python scripts/create_job.py

      # ==========================================================
      # Slack Notification ‚Äì SUCCESS
      # ==========================================================
      - name: Slack Notification - Success
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "‚úÖ *CI/CD Success* ‚Äî Databricks MLOps Pipeline",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Pipeline completed successfully*"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*Models:* `${{ env.MODELS_TO_TRAIN }}`" },
                    { "type": "mrkdwn", "text": "*Commit:* `${{ github.sha }}`" }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # ==========================================================
      # Slack Notification ‚Äì FAILURE
      # ==========================================================
      - name: Slack Notification - Failure
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "‚ùå *CI/CD Failure* ‚Äî Databricks MLOps Pipeline",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Pipeline failed ‚Äî check GitHub Actions logs*"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}





# name: Databricks MLOps CI/CD

# on:
#   push:
#     branches:
#       - main
#     paths:
#       - "dev_env/**"
#       - "prod_env/**"
#       - "uat_env/**"
#       - "scripts/**"
#       - "pipeline_config.yml"
#       - "config.yml"
#       - "requirements.txt"
#       - ".github/workflows/ci-cd-pipeline.yml"

# env:
#   DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
#   DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

# jobs:
#   deploy:
#     name: Deploy to Databricks
#     runs-on: ubuntu-latest

#     steps:
#       # Step 1: Checkout the repo
#       - name: Checkout Repository
#         uses: actions/checkout@v3

#       # Step 2: Set up Python 3.10
#       - name: Setup Python
#         uses: actions/setup-python@v4
#         with:
#           python-version: '3.10'
#           cache: 'pip'

#       # Step 3: Install dependencies
#       - name: Install Dependencies
#         run: |
#           python -m pip install --upgrade pip
#           pip install -r requirements.txt
#           pip install databricks-sdk

#       # Step 4: Sync Repository to Databricks Repos
#       - name: Sync Git Repository to Databricks Repos
#         run: python scripts/add_repo.py

#       # Step 5: Create/Update Databricks Jobs
#       - name: Create or Update Databricks Jobs
#         run: python scripts/create_job.py

#       # -------------------------
#       # üîî Slack Notification Steps
#       # -------------------------

#       - name: Slack Notification - Success
#         if: success()
#         uses: slackapi/slack-github-action@v1.24.0
#         with:
#           payload: |
#             {
#               "text": ":white_check_mark: *CI/CD Success* ‚Äî Databricks MLOps Pipeline",
#               "blocks": [
#                 { "type": "section", "text": { "type": "mrkdwn", "text": "*‚úÖ CI/CD Success*\nDatabricks MLOps pipeline completed successfully." } },
#                 { "type": "section", "fields": [
#                     { "type": "mrkdwn", "text": "*Repo:*\n${{ github.repository }}" },
#                     { "type": "mrkdwn", "text": "*Branch:*\n${{ github.ref }}" },
#                     { "type": "mrkdwn", "text": "*Commit:*\n`${{ github.sha }}`" },
#                     { "type": "mrkdwn", "text": "*Run:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Open Run>" }
#                   ]
#                 }
#               ]
#             }
#         env:
#           SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

#       - name: Slack Notification - Failure
#         if: failure()
#         uses: slackapi/slack-github-action@v1.24.0
#         with:
#           payload: |
#             {
#               "text": ":x: *CI/CD Failure* ‚Äî Databricks MLOps Pipeline",
#               "blocks": [
#                 { "type": "section", "text": { "type": "mrkdwn", "text": "*‚ùå CI/CD Failed*\nPlease check the Actions logs for details." } },
#                 { "type": "section", "fields": [
#                     { "type": "mrkdwn", "text": "*Repo:*\n${{ github.repository }}" },
#                     { "type": "mrkdwn", "text": "*Branch:*\n${{ github.ref }}" },
#                     { "type": "mrkdwn", "text": "*Run:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Open Run>" }
#                   ]
#                 }
#               ]
#             }
#         env:
#           SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
