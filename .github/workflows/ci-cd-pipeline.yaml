name: Databricks MLOps CI/CD

on:
  push:
    branches:
      - main
    paths:
      - "dev_env/**"
      - "prod_env/**"
      - "uat_env/**"
      - "scripts/**"
      - "pipeline_config.yml"
      - "experiments_config.yml"  # ‚úÖ CHANGE 1: Added
      - "requirements.txt"
      - ".github/workflows/ci-cd-pipeline.yml"
  
  # ‚úÖ CHANGE 2: Manual trigger option (optional but useful)
  workflow_dispatch:
    inputs:
      models_to_train:
        description: 'Models to train (comma-separated or "all")'
        required: false
        default: 'all'
        type: string
      environment:
        description: 'Target environment'
        required: false
        default: 'dev'
        type: choice
        options:
          - dev
          - uat
          - prod

env:
  DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
  DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
  # ‚úÖ CHANGE 3: GitHub Variables
  MODELS_TO_TRAIN: ${{ vars.MODELS_TO_TRAIN || 'all' }}
  MODEL_SERVING_CONFIG: ${{ vars.MODEL_SERVING_CONFIG || '{}' }}  # ‚úÖ NEW

jobs:
  # =========================================================================
  # Job 1: Validate Configuration
  # =========================================================================
  validate:
    name: Validate Models Configuration
    runs-on: ubuntu-latest
    outputs:
      models_to_train: ${{ steps.determine_models.outputs.models }}
      models_count: ${{ steps.determine_models.outputs.count }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Determine Models to Train
        id: determine_models
        run: |
          python3 << 'EOF'
          import yaml
          import os
          import sys
          
          # ‚úÖ Read models from GitHub variable or workflow input
          models_input = "${{ github.event.inputs.models_to_train || env.MODELS_TO_TRAIN }}"
          
          print(f"üîç Input received: '{models_input}'")
          
          # Load available models from experiments_config.yml
          try:
              with open("experiments_config.yml", "r") as f:
                  config = yaml.safe_load(f)
              available_models = list(config.get("models", {}).keys())
          except FileNotFoundError:
              print("‚ùå experiments_config.yml not found!")
              sys.exit(1)
          except Exception as e:
              print(f"‚ùå Error reading config: {e}")
              sys.exit(1)
          
          print(f"üìã Available models in config: {available_models}")
          
          # Handle empty or None
          if not models_input or models_input.strip() == "" or models_input.lower() in ["none", "null"]:
              print("‚ùå MODELS_TO_TRAIN is not set!")
              print(f"   Set GitHub variable MODELS_TO_TRAIN to one of:")
              print(f"   - Specific models: 'random_forest,xgboost'")
              print(f"   - All models: 'all'")
              print(f"   Available: {available_models}")
              sys.exit(1)
          
          # Handle "all"
          if models_input.lower().strip() == "all":
              models_to_train = available_models
              print(f"‚úÖ Training ALL models: {models_to_train}")
          else:
              # Parse comma-separated
              models_to_train = [m.strip() for m in models_input.split(",") if m.strip()]
              
              # Validate
              invalid = [m for m in models_to_train if m not in available_models]
              if invalid:
                  print(f"‚ùå Invalid models: {invalid}")
                  print(f"   Available: {available_models}")
                  sys.exit(1)
              
              print(f"‚úÖ Training selected models: {models_to_train}")
          
          # Export for next job
          models_str = ",".join(models_to_train)
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"models={models_str}\n")
              f.write(f"count={len(models_to_train)}\n")
          
          print(f"\nüì§ Output: {models_str}")
          print(f"üìä Count: {len(models_to_train)}")
          EOF

      - name: Display Validation Results
        run: |
          echo "‚úÖ Validation completed successfully!"
          echo "üìã Models to train: ${{ steps.determine_models.outputs.models }}"
          echo "üìä Total models: ${{ steps.determine_models.outputs.count }}"

  # =========================================================================
  # Job 2: Deploy Infrastructure
  # =========================================================================
  deploy:
    name: Deploy to Databricks
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install databricks-sdk

      - name: Sync Git Repository to Databricks Repos
        run: python scripts/add_repo.py

      # ‚úÖ CHANGE 4: Pass both variables
      - name: Create or Update Databricks Jobs
        env:
          MODELS_TO_TRAIN: ${{ needs.validate.outputs.models_to_train }}
          MODEL_SERVING_CONFIG: ${{ env.MODEL_SERVING_CONFIG }}
        run: python scripts/create_job.py

      - name: Display Deployment Info
        run: |
          echo "üéØ Deployment Summary:"
          echo "   Models: ${{ needs.validate.outputs.models_to_train }}"
          echo "   Count: ${{ needs.validate.outputs.models_count }}"
          echo "   Branch: ${{ github.ref }}"
          echo "   Commit: ${{ github.sha }}"

  # =========================================================================
  # Job 3: Trigger Training (Optional)
  # =========================================================================
  trigger_training:
    name: Trigger Model Training
    runs-on: ubuntu-latest
    needs: [validate, deploy]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Databricks CLI
        run: pip install databricks-sdk

      - name: Trigger Training Job
        env:
          MODELS_TO_TRAIN: ${{ needs.validate.outputs.models_to_train }}
        run: |
          python3 << 'EOF'
          from databricks.sdk import WorkspaceClient
          import os
          import json
          
          w = WorkspaceClient(
              host=os.environ["DATABRICKS_HOST"],
              token=os.environ["DATABRICKS_TOKEN"]
          )
          
          models = os.environ["MODELS_TO_TRAIN"]
          
          # Find job by name (adjust this to your job name)
          job_name = "1. dev-ml-training-pipeline"
          
          print(f"üîç Looking for job: {job_name}")
          
          jobs = w.jobs.list()
          target_job = None
          
          for job in jobs:
              if job.settings.name == job_name:
                  target_job = job
                  break
          
          if not target_job:
              print(f"‚ùå Job '{job_name}' not found!")
              exit(1)
          
          print(f"‚úÖ Found job ID: {target_job.job_id}")
          print(f"üöÄ Triggering training with models: {models}")
          
          # Trigger job with models parameter
          run = w.jobs.run_now(
              job_id=target_job.job_id,
              notebook_params={"MODELS_TO_TRAIN": models}
          )
          
          print(f"‚úÖ Training triggered!")
          print(f"   Run ID: {run.run_id}")
          print(f"   Models: {models}")
          
          EOF

  # =========================================================================
  # Notifications
  # =========================================================================
  notify_success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [validate, deploy, trigger_training]
    if: success()
    
    steps:
      - name: Slack Notification - Success
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": ":white_check_mark: *CI/CD Success* ‚Äî Databricks MLOps Pipeline",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*‚úÖ CI/CD Success*\nDatabricks MLOps pipeline completed successfully."
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repo:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.ref }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Models:*\n`${{ needs.validate.outputs.models_to_train }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Count:*\n${{ needs.validate.outputs.models_count }} models"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n`${{ github.sha }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Run:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Open Run>"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  notify_failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [validate, deploy, trigger_training]
    if: failure()
    
    steps:
      - name: Slack Notification - Failure
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": ":x: *CI/CD Failure* ‚Äî Databricks MLOps Pipeline",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*‚ùå CI/CD Failed*\nPlease check the Actions logs for details."
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repo:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.ref }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Failed Job:*\n${{ needs.validate.result }} / ${{ needs.deploy.result }} / ${{ needs.trigger_training.result }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Run:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Open Run>"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}




# name: Databricks MLOps CI/CD

# on:
#   push:
#     branches:
#       - main
#     paths:
#       - "dev_env/**"
#       - "prod_env/**"
#       - "uat_env/**"
#       - "scripts/**"
#       - "pipeline_config.yml"
#       - "config.yml"
#       - "requirements.txt"
#       - ".github/workflows/ci-cd-pipeline.yml"

# env:
#   DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
#   DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

# jobs:
#   deploy:
#     name: Deploy to Databricks
#     runs-on: ubuntu-latest

#     steps:
#       # Step 1: Checkout the repo
#       - name: Checkout Repository
#         uses: actions/checkout@v3

#       # Step 2: Set up Python 3.10
#       - name: Setup Python
#         uses: actions/setup-python@v4
#         with:
#           python-version: '3.10'
#           cache: 'pip'

#       # Step 3: Install dependencies
#       - name: Install Dependencies
#         run: |
#           python -m pip install --upgrade pip
#           pip install -r requirements.txt
#           pip install databricks-sdk

#       # Step 4: Sync Repository to Databricks Repos
#       - name: Sync Git Repository to Databricks Repos
#         run: python scripts/add_repo.py

#       # Step 5: Create/Update Databricks Jobs
#       - name: Create or Update Databricks Jobs
#         run: python scripts/create_job.py

#       # -------------------------
#       # üîî Slack Notification Steps
#       # -------------------------

#       - name: Slack Notification - Success
#         if: success()
#         uses: slackapi/slack-github-action@v1.24.0
#         with:
#           payload: |
#             {
#               "text": ":white_check_mark: *CI/CD Success* ‚Äî Databricks MLOps Pipeline",
#               "blocks": [
#                 { "type": "section", "text": { "type": "mrkdwn", "text": "*‚úÖ CI/CD Success*\nDatabricks MLOps pipeline completed successfully." } },
#                 { "type": "section", "fields": [
#                     { "type": "mrkdwn", "text": "*Repo:*\n${{ github.repository }}" },
#                     { "type": "mrkdwn", "text": "*Branch:*\n${{ github.ref }}" },
#                     { "type": "mrkdwn", "text": "*Commit:*\n`${{ github.sha }}`" },
#                     { "type": "mrkdwn", "text": "*Run:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Open Run>" }
#                   ]
#                 }
#               ]
#             }
#         env:
#           SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

#       - name: Slack Notification - Failure
#         if: failure()
#         uses: slackapi/slack-github-action@v1.24.0
#         with:
#           payload: |
#             {
#               "text": ":x: *CI/CD Failure* ‚Äî Databricks MLOps Pipeline",
#               "blocks": [
#                 { "type": "section", "text": { "type": "mrkdwn", "text": "*‚ùå CI/CD Failed*\nPlease check the Actions logs for details." } },
#                 { "type": "section", "fields": [
#                     { "type": "mrkdwn", "text": "*Repo:*\n${{ github.repository }}" },
#                     { "type": "mrkdwn", "text": "*Branch:*\n${{ github.ref }}" },
#                     { "type": "mrkdwn", "text": "*Run:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Open Run>" }
#                   ]
#                 }
#               ]
#             }
#         env:
#           SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
